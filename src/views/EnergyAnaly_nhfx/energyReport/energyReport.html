<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>能耗统计</title>
    <link rel="stylesheet" href="./../../../layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="./../../../layuiadmin/style/admin.css" media="all">
    <link rel="stylesheet" href="./../../../layuiadmin/style/firmMonitor.css">
    <link rel="stylesheet" href="./../../../layuiadmin/plugin/element.css">
    <style>
        .layui-inline {
            margin: 0 0 10px 60px;
        }

        .allTable {
            text-align: center;
            white-space: nowrap;
            overflow-x: auto;
            width: auto;
        }

        .tableList {
            width: 100%;
            /* position: absolute; */
            background-color: #fff;

        }

        .tableList tr {
            height: 48px;
            line-height: 48px;
        }

        .tableList tr th {
            color: #909399;
        }

        .tableList tr th,
        .tableList tr td {
            border: 1px solid #eee;
            text-align: center;
            padding: 6px;
        }

        .layui-block {
            margin: 10px 0 10px 0;
        }

        [v-cloak] {
            display: none
        }
    </style>
</head>

<body>
    <div id="vm">
        <div class="firmMain">
            <div class="firmLeft">
                <div class="title"></div>
                <div class="leftContent">
                    <el-tree default-expand-all highlight-current :data="energyData" :expand-on-click-node="false" :props="defaultProps" @node-click="handleNodeClick"></el-tree>
                </div>
            </div>
            <div class="firmRight">
                <span>企业名称：</span>
                <span v-text="enpriseName"></span>
                <div class="layui-block layui-form">
                    <div class="layui-input-inline" style="width: 120px;">
                        <el-select v-model="timeType" @change="timeSelect" placeholder="请选择">
                            <el-option v-for="item in timeOptions" :key="item.value" :label="item.label" :value="item.value">
                            </el-option>
                        </el-select>
                    </div>
                    <div class="layui-input-inline" v-show="timeShow == 1">
                        <el-date-picker v-model="timeDate" value-format="yyyy-MM-dd" type="date" placeholder="选择日期">
                        </el-date-picker>
                        <!-- <input type="text" class="layui-input" id="timeDate" placeholder="请选择日期"> -->
                    </div>
                    <div class="layui-input-inline" v-show="timeShow == 2">
                        <el-date-picker v-model="yearDate" value-format="yyyy" type="year" placeholder="选择年">
                        </el-date-picker>
                        <!-- <input type="text" class="layui-input" id="yearDate" placeholder="请选择年"> -->
                    </div>
                    <div class="layui-input-inline" v-show="timeShow == 3">
                        <el-date-picker v-model="monthDate" value-format="yyyyMM" type="month" placeholder="选择月">
                        </el-date-picker>
                        <!-- <input type="text" class="layui-input" id="monthDate" placeholder="请选择月"> -->
                    </div>
                    <button class="layui-btn layuiadmin-btn-list layui-bg-orange layui-icon  layui-icon-link" @click="downExport">导出</button>
                </div>
                <div class="allTable">
                    <table class="tableList" v-show="reportDataDay.length!=0">
                        <tr>
                            <th v-for="(item,index) in dataTime" v-text="item"></th>
                        </tr>
                        <tr v-for="(it,index) in reportDataDay" v-show="reportDataDay.length!=0">
                            <td v-for="(item,index) in it" v-cloak>{{item}}</td>
                        </tr>
                        <!-- <tr v-show="reportDataDay.length==0">
                            <td :colspan="dataTime.length">暂无数据</td>
                        </tr> -->
                    </table>
                    <div v-show="reportDataDay.length==0">
                        暂无数据
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- <script src="./../../../layuiadmin/plugin/browser.min.js"></script> -->
    <script src="./../../../layuiadmin/plugin/polyfill.min.js"></script>
    <script src="./../../../layuiadmin/layui/layui.js"></script>
    <script src="./../../../layuiadmin/plugin/vue.js"></script>
    <script src="./../../../layuiadmin/plugin/element.js"></script>
    <script src="./../../../layuiadmin/plugin/axios.js"></script>
    <script src="./../../../layuiadmin/js/baseUrlConfig.js"></script>
    <script>
        layui.config({
            base: '../../../layuiadmin/' //静态资源所在路径
        }).extend({
            index: 'lib/index' //主入口模块
        }).use(['index', 'table', 'laydate', 'form', 'jquery'], function () {
            var form = layui.form,
                table = layui.table,
                $ = layui.jquery,
                laydate = layui.laydate;
            //时间日期
            // laydate.render({
            //     elem: '#timeDate',
            //     format: 'yyyy-MM-dd'
            // });
            // laydate.render({
            //     elem: '#yearDate',
            //     type: 'year'
            // });
            // laydate.render({
            //     elem: '#monthDate',
            //     type: 'month'
            // });

            // table.render({
            //     elem: '#LAY-app-content-list',
            //     height: 555 //容器高度
            //     ,
            //     url: layui.setter.BASEURL + '/environmental_intelligent_monitoring/tbasenterprise/list' //数据接口
            //     ,
            //     page: true,
            //     parseData: function (res) { // 数据重新处理为layUI的数据格式
            //         var msg = {
            //             "code": res.code, //解析接口状态
            //             "msg": res.msg, //解析提示文本
            //             "count": res.page.totalCount, //解析数据长度
            //             "data": res.page.list //解析数据列表
            //         };
            //         return msg;
            //     },
            //     cols: [
            //         [{
            //             title: '企业名称',
            //             field: 'name',
            //             minWidth: 100
            //         }, {
            //             title: '企业社会信用代码',
            //             field: 'trustCode',
            //             minWidth: 100,
            //             width: 200
            //         }, {
            //             title: '地址',
            //             field: 'address',
            //             minWidth: 100,
            //             width: 200
            //         }, {
            //             title: '行业名称',
            //             field: 'tradeName',
            //             minWidth: 100
            //         }, {
            //             title: '创建时间',
            //             field: 'createDate',
            //             minWidth: 100
            //         }
            //         ]
            //     ] //设置表头
            //     ,
            //      limit: 15,
            //     limits: [15, 30, 50, 100, 200]
            // });

            // 监听select框选择事件
            // form.on('select(timeType)', function (data) {
            //     // console.log(data)
            //     if (data.value == 'year') {
            //         vm.timeShow = 2;

            //     } else if (data.value == 'month') {
            //         vm.timeShow = 3;

            //     } else if (data.value == 'date') {
            //         vm.timeShow = 1;
            //     } else {
            //         vm.timeShow = 0;
            //     }

            // })
        })

        var vm = new Vue({
            el: "#vm",
            data: {
                defaultProps: {
                    children: 'children',
                    label: 'title'
                },
                energyData: [],
                timeShow: 1,
                loading: false,
                enpriseName: "",
                enpriseId: "",
                // 时间选择
                timeType: "date",
                timeOptions: [{
                    label: '日',
                    value: 'date'

                }, {
                    label: '月',
                    value: 'month'

                }, {
                    label: '年',
                    value: 'year'

                }, {
                    label: '累计',
                    value: 'plus'

                }],
                reportDataDay: [],
                dataTime: [],
                // 时间
                timeDate: "",
                yearDate: "",
                monthDate: "",
                flag: ""
            },
            watch: {
                timeDate: function (val) {
                    this.enpriseDay(this.enpriseId)
                },
                yearDate: function (val) {
                    this.enpriseYear(this.enpriseId)
                },
                monthDate: function (val) {
                    this.enpriseMonth(this.enpriseId)
                }
            },
            methods: {
                // 为时间添加默认时间
                timePicker: function () {
                    // // console.log(this.timeShow)
                    var now = new Date();
                    var year = now.getFullYear(); //得到年份
                    var month = now.getMonth() + 1; //得到月份
                    var date = now.getDate(); //得到日期
                    if (this.timeShow == 1) {
                        // var defaultDate = `${year}-${month}-${date}`;
                        var defaultDate = year + '-' + month + '-' + date;
                        this.timeDate = defaultDate;
                    } else if (this.timeShow == 2) {
                        var defaultDate = year + "";
                        this.yearDate = defaultDate;
                    } else if (this.timeShow == 3) {
                        var defaultDate = year + "" + month;
                        this.monthDate = defaultDate;
                    }
                },
                // select选择
                timeSelect: function () {
                    if (this.timeType == 'year') {
                        vm.timeShow = 2;
                        this.enpriseYear(this.enpriseId)

                    } else if (this.timeType == 'month') {
                        vm.timeShow = 3;
                        this.enpriseMonth(this.enpriseId)

                    } else if (this.timeType == 'date') {
                        vm.timeShow = 1;
                        this.enpriseDay(this.enpriseId)
                    } else {
                        vm.timeShow = 0;
                        this.enprisePlus(this.enpriseId)
                    }
                    this.timePicker();
                },
                energyTreeInit: function () {
                    this.loading = true;
                    axios({
                        method: "post",
                        // url: BASEURL + 'environmental_intelligent_monitoring/tbasorganize/list?limit=10000',
                        url: BASEURL + 'environmental_intelligent_monitoring/tbasorganize/dendrogramList',
                        params: {
                            type: "3",
                            userId: window.localStorage.getItem("userId")
                        }
                    }).then(function (res) {
                        if (res.data.code == 0) {
                            vm.loading = false;
                            var data = res.data.data;
                            vm.energyData = data;
                        } else {
                            vm.loading = false;
                            vm.$notify.error({
                                title: '错误',
                                message: res.data.msg
                            });

                        }
                    }).catch(function (err) {
                        // console.log(err);
                    });
                },
                handleNodeClick: function (data, node) {
                    if (data.type == "t_bas_enterprise") {
                        // // console.log(data)
                        this.enpriseName = data.title;
                        this.enpriseId = data.id;

                        if (this.timeType == 'year') {
                            if (this.yearDate == "") {
                                vm.$message.warning('请输入日期')
                            } else {
                                this.enpriseYear(this.enpriseId);
                            }
                        } else if (this.timeType == 'month') {
                            if (this.monthDate == "") {
                                vm.$message.warning('请输入日期')
                            } else {
                                this.enpriseMonth(this.enpriseId);
                            }
                        } else if (this.timeType == 'date') {
                            if (this.timeDate == "") {
                                vm.$message.warning('请输入日期')
                            } else {
                                this.enpriseDay(this.enpriseId);
                            }

                        } else if (this.timeType == 'plus') {
                            this.enprisePlus(this.enpriseId);
                        }

                    }

                },
                // 获取月份的时间
                getMonthDays: function (year, month) {
                    var thisDate = new Date(year, month, 0); //当天数为0 js自动处理为上一月的最后一天
                    return thisDate.getDate();
                },
                // 企业能耗统计报表表头
                headerInit() {
                    var hourData = ['监测点名称'];
                    for (var i = 0; i < 24; i++) {
                        hourData.push(i + '时');
                    }
                    this.dataTime = hourData;
                    // console.log(this.dataTime)
                },
                // 企业能耗统计报表按天统计
                enpriseDay: function (enterpriseId) {
                    if (enterpriseId != "") {
                        axios({
                            method: "post",
                            url: BASEURL + 'environmental_intelligent_monitoring/tkwhhour/query',
                            params: {
                                dailyTime: this.timeDate,
                                // enterpriseId: 89
                                enterpriseId: enterpriseId,
                                userId: window.localStorage.getItem("userId")
                            }
                        }).then(function (res) {
                            if (res.data.code == 0) {
                                // console.log(res.data.data)
                                var allData = res.data.data;
                                if (allData.length != 0) {
                                    allData.forEach(function (data) {
                                        // console.log(data);
                                        var hourData = [];
                                        for (let key in data) {
                                            if (key == 'monitorName') {
                                                key = '监测点名称';
                                            }
                                            hourData.push(key);
                                        }
                                        vm.dataTime = hourData;
                                        /*  var json = JSON.parse(JSON.stringify(data).replace(/monitorName/g,"监测点名称"));
                                         hourData.push(json); */
                                    });
                                    vm.flag = '';
                                } else {
                                    vm.flag = 'noData';
                                }
                                vm.reportDataDay = allData;


                                // vm.reportDataDay = [];
                                // var allData = res.data.data;
                                // var timeData = [];
                                // for (var i = 0; i < 24; i++) {
                                //     if (i < 10) {
                                //         i = '0' + i;
                                //     }
                                //     timeData.push(i);
                                // }
                                // vm.dataTime = timeData;
                                // function compare(property) {
                                //     return function (a, b) {
                                //         var value1 = a[property];
                                //         var value2 = b[property];
                                //         return value1 - value2;
                                //     }
                                // }
                                // // // console.log(timeData);
                                // var dataItem = [];

                                // allData.forEach(function (data) {
                                //     // console.log(data);
                                //     var obj = {};
                                //     var sortData = [];
                                //     timeData.forEach(t1 => {

                                //         let exist = data.tKwhlist.some(t2 => t1 == t2.time);
                                //         // console.log(exist);
                                //         if (!exist) {
                                //             sortData.push({
                                //                 time: t1,
                                //                 kwh: 0
                                //             });
                                //         }

                                //     });
                                //     // // console.log(sortData)       
                                //     data.tKwhlist.forEach(function (item) {
                                //         sortData.push(item)
                                //     })
                                //     // console.log(sortData)
                                //     dataItem = sortData.sort(compare('time'));
                                //     obj.monitorName = data.monitorName;
                                //     obj.list = dataItem;
                                //     vm.reportDataDay.push(obj);
                                // })
                                // // console.log(vm.reportDataDay)

                            } else if (res.data.code == 203) {
                                vm.$notify({
                                    title: '提示',
                                    message: res.data.msg,
                                    type: 'warning'
                                });
                                vm.flag = 'noData';
                            } else {
                                vm.$notify.error({
                                    title: '错误',
                                    message: res.data.msg
                                });
                                vm.reportDataDay = [];

                            }
                        })
                            .catch(function (err) {
                                // console.log(err);
                            });
                    } else {
                        var h = this.$createElement;
                        vm.$message.warning({
                            offset: 4,
                            message: '请选择企业'
                        })
                        // vm.$notify({
                        //     title: '提示',
                        //     message: '请选择企业',
                        //     type: 'warning'
                        // });


                    }

                },
                // 企业能耗统计报表按月统计
                enpriseMonth: function (enterpriseId) {
                    // console.log(this.monthDate);
                    if (enterpriseId != "") {
                        var year = this.monthDate.substring(0, 4);
                        var month = this.monthDate.substring(4, 6);
                        var num = this.getMonthDays(year, month);
                        axios({
                            method: "post",
                            url: BASEURL + 'environmental_intelligent_monitoring/tkwhdaily/query',
                            params: {
                                monthTime: this.monthDate,
                                enterpriseId: enterpriseId,
                                num: num,
                                userId: window.localStorage.getItem("userId")
                            }
                        }).then(function (res) {
                            if (res.data.code == 0) {
                                var allData = res.data.data;

                                if (allData.length != 0) {
                                    allData.forEach(function (data) {
                                        var hourData = [];
                                        // // console.log(data);
                                        for (let key in data) {
                                            // // console.log(key + '---' + data[key]);
                                            if (key == 'monitorName') {
                                                key = '监测点名称';
                                            }
                                            hourData.push(key);
                                        }
                                        vm.dataTime = hourData;
                                        /*  var json = JSON.parse(JSON.stringify(data).replace(/monitorName/g,"监测点名称"));
                                         hourData.push(json); */
                                    });

                                    vm.flag = '';

                                } else {
                                    vm.flag = 'noData';
                                }
                                vm.reportDataDay = allData;


                            } else if (res.data.code == 203) {
                                vm.$notify({
                                    title: '提示',
                                    message: res.data.msg,
                                    type: 'warning'
                                });
                                vm.flag = 'noData';
                            } else {
                                vm.$notify.error({
                                    title: '错误',
                                    message: res.data.msg
                                });
                                vm.reportDataDay = [];

                            }
                        })
                            .catch(function (err) {
                                // console.log(err);
                            });
                    } else {
                        // vm.$notify({
                        //     title: '提示',
                        //     message: '请选择企业',
                        //     type: 'warning'
                        // });
                        vm.$message.warning({
                            offset: 4,
                            message: '请选择企业'
                        })
                    }

                },
                // 企业能耗统计报表按年统计
                enpriseYear: function (enterpriseId) {
                    if (enterpriseId != "") {
                        axios({
                            method: "post",
                            url: BASEURL + 'environmental_intelligent_monitoring/tkwhmonthly/query',
                            params: {
                                yearTime: this.yearDate,
                                enterpriseId: enterpriseId,
                                userId: window.localStorage.getItem("userId")
                            }
                        }).then(function (res) {
                            if (res.data.code == 0) {
                                var allData = res.data.data;
                                if (allData.length != 0) {
                                    allData.forEach(function (data) {
                                        var hourData = [];
                                        // console.log(data);
                                        for (let key in data) {
                                            // console.log(key + '---' + data[key]);
                                            if (key == 'monitorName') {
                                                key = '监测点名称';
                                            }
                                            hourData.push(key);
                                        }
                                        vm.dataTime = hourData;
                                        /*  var json = JSON.parse(JSON.stringify(data).replace(/monitorName/g,"监测点名称"));
                                         hourData.push(json); */
                                    });
                                    vm.flag = '';

                                } else {
                                    vm.flag = 'noData';
                                }
                                vm.reportDataDay = allData;


                            } else if (res.data.code == 203) {
                                vm.$notify({
                                    title: '提示',
                                    message: res.data.msg,
                                    type: 'warning'
                                });
                                vm.flag = 'noData';
                            } else {
                                vm.$notify.error({
                                    title: '错误',
                                    message: res.data.msg
                                });
                                vm.reportDataDay = [];

                            }

                        })
                            .catch(function (err) {
                                // console.log(err);
                            });
                    }
                    else {
                        // vm.$notify({
                        //     title: '提示',
                        //     message: '请选择企业',
                        //     type: 'warning'
                        // });
                        vm.$message.warning({
                            offset: 4,
                            message: '请选择企业'

                        })

                    }

                },
                // 企业能耗统计报表累计统计
                enprisePlus: function (enterpriseId) {
                    if (enterpriseId != "") {
                        axios({
                            method: "post",
                            url: BASEURL + 'environmental_intelligent_monitoring/tkwhyear/query',
                            params: {
                                enterpriseId: enterpriseId,
                                userId: window.localStorage.getItem("userId")
                            }
                        }).then(function (res) {
                            if (res.data.code == 0) {
                                var allData = res.data.data;
                                if (allData.length != 0) {
                                    allData.forEach(function (data) {
                                        var hourData = [];
                                        // // console.log(data);
                                        for (var key in data) {
                                            // // console.log(key + '---' + data[key]);
                                            hourData.push(key);
                                        }
                                        vm.dataTime = hourData;
                                        /*  var json = JSON.parse(JSON.stringify(data).replace(/monitorName/g,"监测点名称"));
                                         hourData.push(json); */
                                    });


                                    vm.flag = '';

                                } else {
                                    vm.flag = 'noData';

                                }
                                vm.reportDataDay = allData;

                                // vm.reportDataDay = [];
                                // var allData = res.data.data;
                                // var all = [];
                                // var timeData = [];
                                // allData.forEach(function (data) {
                                //     for (var i = 0; i < data.tKwhlist.length; i++) {
                                //         // console.log(data.tKwhlist[i])
                                //         all.push(data.tKwhlist[i])
                                //     }

                                // })
                                // for (var i = 0; i < all.length; i++) {
                                //     timeData.push(all[i].time);
                                // }
                                // vm.dataTime = timeData.filter((item, index, self) => self.indexOf(item) === index);

                                // function compare(property) {
                                //     return function (a, b) {
                                //         var value1 = a[property];
                                //         var value2 = b[property];
                                //         return value1 - value2;
                                //     }
                                // }
                                // // // console.log(timeData);
                                // var dataItem = [];

                                // allData.forEach(function (data) {
                                //     // console.log(data);
                                //     var obj = {};
                                //     var sortData = [];
                                //     timeData.forEach(t1 => {

                                //         let exist = data.tKwhlist.some(t2 => t1 == t2.time);
                                //         // console.log(exist);
                                //         if (!exist) {
                                //             sortData.push({
                                //                 time: t1,
                                //                 kwh: 0
                                //             });
                                //         }

                                //     });
                                //     // // console.log(sortData)       
                                //     data.tKwhlist.forEach(function (item) {
                                //         sortData.push(item)
                                //     })
                                //     // console.log(sortData)
                                //     dataItem = sortData.sort(compare('time'));
                                //     obj.monitorName = data.monitorName;
                                //     obj.list = dataItem;
                                //     vm.reportDataDay.push(obj);
                                // })
                                // // console.log(vm.reportDataDay)


                                // for (var i = 1; i < allData.length; i++) {
                                //     allData[i].list =  allData[i].tKwhlist;
                                // }
                                // vm.reportDataDay = allData; 

                            } else if (res.data.code == 203) {
                                vm.$notify({
                                    title: '提示',
                                    message: res.data.msg,
                                    type: 'warning'
                                });
                                vm.flag = 'noData';
                            } else {
                                vm.$notify.error({
                                    title: '错误',
                                    message: res.data.msg
                                });
                                vm.reportDataDay = [];

                            }
                        })
                            .catch(function (err) {
                                // console.log(err);
                            });

                    } else {
                        // vm.$notify({
                        //     title: '提示',
                        //     message: '请选择企业',
                        //     type: 'warning'
                        // });
                        vm.$message.warning({
                            offset: 4,
                            message: '请选择企业'

                        })
                    }


                },
                downExport: function () {
                    // 数据处理
                    if (vm.flag == 'noData') {
                        vm.$message.warning('无数据导出');
                    } else {
                        var type;
                        if (this.enpriseId != 0) {
                            if (this.timeType == 'year') {
                                type = 'year';
                                // // console.log(this.enpriseId, this.enpriseName)
                                location = BASEURL + 'environmental_intelligent_monitoring/tkwhhour/exportExcel?'
                                    + "yearTime=" + this.yearDate + "&"
                                    + "enterpriseId=" + this.enpriseId + "&"
                                    + "flag=" + type + "&"
                                    + "title=" + this.enpriseName;
                            } else if (this.timeType == 'month') {
                                type = 'month';
                                // console.log(this.enpriseId, this.enpriseName)
                                var year = this.monthDate.substring(0, 4);
                                var month = this.monthDate.substring(4, 6);
                                var num = this.getMonthDays(year, month);
                                // console.log(num)
                                location = BASEURL + 'environmental_intelligent_monitoring/tkwhhour/exportExcel?'
                                    + "monthTime=" + this.monthDate + "&"
                                    + "enterpriseId=" + this.enpriseId + "&"
                                    + "flag=" + type + "&"
                                    + "num=" + num + "&"
                                    + "title=" + this.enpriseName;
                            } else if (this.timeType == 'date') {
                                type = 'daily';
                                // console.log(this.enpriseId, this.enpriseName)
                                location = BASEURL + 'environmental_intelligent_monitoring/tkwhhour/exportExcel?'
                                    + "dailyTime=" + this.timeDate + "&"
                                    + "enterpriseId=" + this.enpriseId + "&"
                                    + "flag=" + type + "&"
                                    + "title=" + this.enpriseName;
                            } else {
                                type = 'sumyear';
                                // console.log(this.enpriseId, this.enpriseName)
                                location = BASEURL + 'environmental_intelligent_monitoring/tkwhhour/exportExcel?'
                                    + "enterpriseId=" + this.enpriseId + "&"
                                    + "flag=" + type + "&"
                                    + "title=" + this.enpriseName;

                            }

                        } else {
                            vm.$message.warning('请选择企业');
                        }
                    }
                }
            },
            created: function () {
                this.energyTreeInit();
                // 默认时间
                this.timePicker();
                // 表格标题展示
                // this.headerInit();
            }
        })
    </script>
</body>

</html>