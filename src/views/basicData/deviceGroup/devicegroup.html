<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>设备分组</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="./../../../layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" type="text/css" href="./../../../layuiadmin/plugin/element.css" />
    <link rel="stylesheet" href="./../../../layuiadmin/style/admin.css" media="all">
    <link rel="stylesheet" type="text/css" href="./../../../layuiadmin/style/tbasenterpriseallocate.css" />
    <link rel="stylesheet" type="text/css" href="./../../../layuiadmin/style/common.css" />
    <style>
        .card-title {
            color: #fff;
        }

        .layui-input,
        .layui-select,
        .el-input__inner {
            height: 32px;
            width: 200px;
        }

        .user-list-box {
            padding-left: 10px;
        }

        .layui-form-select dl {
            color: #000;
        }

        .layui-card .layui-icon-triangle-d {
            color: #c2c2c2;
        }

        .layui-card .layui-icon-triangle-d,
        .layui-card .layui-icon-search {
            cursor: pointer;
        }

        .layui-col-space30 {
            margin: 0;
        }

        .l-card-border {
            padding: 10px;
        }

        .layui-icon-edit,
        .layui-icon-close {
            cursor: pointer;
            font-weight: 700;
            font-size: 18px;
        }

        .layui-icon-edit {
            color: #0f0;
        }

        .layui-icon-close {
            color: #f00;

        }
    </style>
</head>

<body>
    <div id="vm">
        <div class="layui-fluid layui-col-space30">
            <div class="layui-card layui-col-md4 layui-col-lg4" style="min-height: 500px;">
                <div class="layui-card-header card-title">
                    <div class="layui-inline">
                        <div class="layui-input-inline">
                            <input type="text" id="enterpriseName" placeholder="企业名称" name="enterpriseName" class="layui-input">
                        </div>
                        <!-- <div class="layui-inline" style="width: 40px;">
                            <i class="layui-icon layui-icon-search layuiadmin-button-btn" @click="laySearch"></i>
                        </div> -->
                    </div>
                </div>
                <div class="l-card-border">
                    <el-tree :data="enpriseData" default-expand-all @node-click="handleNodeClick" node-key="monitorId" ref="tree" highlight-current  :expand-on-click-node="false"
                        :props="defaultProps">
                    </el-tree>
                </div>
            </div>
            <div class="layui-card layui-col-md8 layui-col-lg8" style="min-height: 800px;">
                <div class="layui-card-header card-title">企业名称&nbsp;&nbsp;
                </div>
                <div class="l-card-border">
                    <table id="LAY-app-content-list" lay-filter="LAY-app-content-list"></table>
                    <script type="text/html" id="barDemo">
						<a class="layui-icon layui-icon-edit" lay-event="deviceEdit"></a>
						<a class="layui-icon layui-icon-close" lay-event="deviceDelete"></a>
					</script>
                </div>
            </div>
        </div>
        <script src="./../../../layuiadmin/js/baseUrlConfig.js"></script>
        <script src="./../../../layuiadmin/layui/layui.js"></script>
        <script src="./../../../layuiadmin/plugin/vue.min.js"></script>
        <script src="./../../../layuiadmin/plugin/element.js"></script>
        <script src="./../../../layuiadmin/plugin/axios.js"></script>
        <script>
            var vm = new Vue({
                el: "#vm",
                data: {
                    // treeHign: false,
                    treeData: [],
                    defaultProps: {
                        children: 'children',
                        label: 'label'
                    },
                    atraName: "",
                    enpriseData: [],
                    enterpriseName: "",
                    trade: "",
                    monitorIdData: [],
                    checkKey: [],
                    monitoridList: []

                },
                methods: {
                    // 企业列表树状图
                    enterPriseInit() {
                        axios({
                            method: "post",
                            url: BASEURL + 'environmental_intelligent_monitoring/tdevicemonitor/list?limit=10000',
                            params: {}
                        }).then(function (res) {
                            if (res.data.code == 0) {
                                var treeData = res.data.page.list;
                                var dataList = [];
                                // vm.enpriseData = res.data.page.list;
                                treeData.forEach(function (data) {
                                    for (var i = 0; i < dataList.length; i++) {
                                        if (dataList[i].enterpriseId === data.enterpriseId) {
                                            dataList[i].children.push({
                                                label: data.shopName,
                                                // children: [{
                                                //     label: data.type === "1" ? '生产设备' : '治污设备',
                                                //     // id: data.type,
                                                //     children: [{ label: data.monitorName, monitorId: data.id }]
                                                // }]
                                            });
                                            dataList[i].num++;
                                            return;
                                        }
                                    }


                                    dataList.push({
                                        label: data.enterpriseName,
                                        enterpriseId: data.enterpriseId,
                                        num: 1,
                                        children: [{
                                            label: data.shopName,
                                            // children: [{
                                            //     label: data.type === "1" ? '生产设备' : '治污设备',
                                            //     id: data.type,
                                            //     children: [{ label: data.monitorName, monitorId: data.id }]
                                            // }]
                                        }]
                                    });
                                })
                                // console.log(dataList)
                                vm.enpriseData = dataList;

                            }

                        }).catch(function (err) {
                            console.log(err);
                        });

                    },

                    // 树状图组件
                    treeDataInit() {
                        axios({
                            method: "post",
                            url: BASEURL + 'environmental_intelligent_monitoring/tbasorganize/list?limit=10000',
                            params: {
                                parentId: 0
                            }
                        }).then(function (res) {
                            if (res.data.code == 0) {

                                vm.treeData = [];
                                // vm.treeData = res.data.page.list;
                                var data = res.data.page.list;

                                for (var i = 0; i < data.length; i++) {
                                    var obj = {};
                                    obj.label = data[i].name;
                                    obj.id = data[i].id;
                                    obj.parentId = data[i].parentId;
                                    obj.children = [];
                                    vm.treeData.push(obj);
                                }


                            } else {

                            }
                        }).catch(function (err) {
                            console.log(err);
                        });

                    },
                    handleNodeClick(data, node) {
                        console.log(data, node);
                        vm.atraName = data.label;
                        // vm.treeHign = true;

                        // axios({
                        //     method: "post",
                        //     url: BASEURL + 'environmental_intelligent_monitoring/tbasorganize/list?limit=10000',
                        //     params: {
                        //         parentId: data.id
                        //     }
                        // }).then(function (res) {
                        //     if (res.data.code == 0) {

                        //         // vm.treeData = res.data.page.list;
                        //         var treedata = res.data.page.list;
                        //         // console.log(treedata)
                        //         // for (var i = 0; i < vm.treeData.length; i++) {
                        //         data.children = [];
                        //         for (var j = 0; j < treedata.length; j++) {

                        //             // if (vm.treeData[i].id == data[j].parentId) {
                        //             if (data.id == treedata[j].parentId) {
                        //                 // console.log(treedata[j])
                        //                 let obj = {
                        //                     label: treedata[j].name,
                        //                     id: treedata[j].id,
                        //                     parentId: treedata[j].parentId,
                        //                     children: []
                        //                 };
                        //                 data.children.push(obj);
                        //             }
                        //         }
                        //         // }


                        //     } else {
                        //         vm.$notify.error({
                        //             title: '错误',
                        //             message: res.data.msg
                        //         });
                        //     }
                        // }).catch(function (err) {
                        //     console.log(err);
                        // });
                    },
                    // 复选框选中
                    manageCheck(data, node) {
                        vm.monitoridList = [];
                        var data = this.$refs.tree.getCheckedNodes(true);
                        console.log(data)

                        for (var i = 0; i < data.length; i++) {
                            console.log(data[i]);
                            // console.log(dataItem)
                            // var obj = {};
                            vm.enpriseData.forEach(function (item, index) {
                                // console.log(item,index)

                                item.children.forEach(function (it, index) {
                                    it.children.forEach(function (itthird, index) {
                                        itthird.children.forEach(function (itfourth, index) {
                                            // console.log(itfourth);



                                            if (itfourth.monitorId === data[i].monitorId && itfourth.label === data[i].label) {

                                                // console.log(dataItem);
                                                // console.log(item)

                                                data[i].monitorId = itfourth.monitorId;
                                                data[i].monitorName = itfourth.label;
                                                data[i].enterpriseId = item.enterpriseId;
                                                data[i].enterpriseName = item.label;
                                                // vm.monitorIdData.push(obj);
                                                // delete data[i].label;
                                            }



                                        })
                                    })
                                })

                            })



                        }
                        vm.monitorIdData = data;
                        vm.monitorIdData.forEach(function (item, index) {
                            console.log(item);
                            vm.monitoridList.push(item.monitorId);
                        })
                        console.log(vm.monitoridList)


                    },
                    laySearch() {

                    }
                },
                created() {
                    this.enterPriseInit();
                    // 树状图调用
                    this.treeDataInit();
                },
                mounted: function () {
                    // 初始化加载
                    // this.pageInit();
                },

            })





            layui.config({
                base: '../../../layuiadmin/' //静态资源所在路径
            }).extend({
                index: 'lib/index' //主入口模块
            }).use(['index', 'form', 'jquery', 'table'], function () {

                var form = layui.form,
                    $ = layui.jquery,
                    table = layui.table;


                table.render({
                    elem: '#LAY-app-content-list'
                    , height: 450 //容器高度
                    , url: layui.setter.BASEURL + 'environmental_intelligent_monitoring/twarnset/list' //数据接口
                    , page: true
                    , parseData: function (res) { // 数据重新处理为layUI的数据格式
                        var msg = {
                            "code": res.code, //解析接口状态
                            "msg": res.msg, //解析提示文本
                            "count": res.page.totalCount, //解析数据长度
                            "data": res.page.list //解析数据列表
                        };
                        return msg;
                    }
                    , cols: [[
                        // { type: 'numbers', width: 50, fixed: 'left' },
                        // { checkbox: true },
                        { title: '生产单元', field: 'monitorName', minWidth: 100 },
                        { title: '产污监测点', field: 'eventType', minWidth: 120 },
                        // { title: '事件类型编码', field: 'eventtypeid', minWidth: 100 },
                        { title: '治污监测点', field: 'parameterCode', minWidth: 120 },
                        { title: '备用关系', field: 'condition', minWidth: 80 },
                        { fixed: 'right', title: '操作', toolbar: '#barDemo', width: 100 }
                    ]] //设置表头
                    , limit: 10
                    , limits: [10, 15, 20, 25, 30]
                    , done: function (res, page, count) {
                        $("[data-field='active']").children().each(function () {
                            if ($(this).text() == '1') {
                                $(this).text("启用")
                            } else if ($(this).text() == '2') {
                                $(this).text("禁用")
                            }
                        })

                        $("[data-field='status']").children().each(function () {
                            if ($(this).text() == '1') {
                                $(this).text("有效")
                            } else if ($(this).text() == '2') {
                                $(this).text("无效")
                            }
                        })
                    }
                });
                //执行重载
                table.reload('LAY-app-content-list', {
                    // where: field
                });

                //监听工具条
                table.on('tool(LAY-app-content-list)', function (obj) { //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
                    console.log(obj)
                    var data = obj.data //获得当前行数据
                        , layEvent = obj.event; //获得 lay-event 对应的值
                    // console.log(data.enterpriseId)
                    if (layEvent === 'deviceDelete') {
                        layer.confirm('确定删除吗？', function (index) {

                            //执行 Ajax 后重载
                            /*
                            admin.req({
                              url: 'xxx'
                              //,……
                            });
                            */
                            table.reload('LAY-app-content-list');
                            layer.msg('已删除');
                        });


                    } else if (layEvent === 'deviceEdit') {
                        window.id = data.id;
                        window.currentStatus = data.currentStatus;
                        layer.open({
                            type: 2,
                            title: '设备关联信息',
                            area: ['700px', '450px'],//弹框大小
                            // offset: ['50px', '300px'],
                            content: 'groupEdit.html' //这里content是一个普通的String
                        });
                    }
                });





            });
        </script>
</body>

</html>